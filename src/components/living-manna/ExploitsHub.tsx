import { useState, useEffect } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Textarea } from "@/components/ui/textarea";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { supabase } from "@/integrations/supabase/client";
import { useAuth } from "@/hooks/useAuth";
import { toast } from "sonner";
import { 
  Flame, Sparkles, RefreshCw, Send, Heart, Globe, Users, 
  BookOpen, Lightbulb, Share2, ThumbsUp, MessageCircle,
  Loader2, Target, Zap, Compass, HandHeart
} from "lucide-react";

interface ExploitsHubProps {
  churchId: string;
}

interface ExploitIdea {
  id: string;
  title: string;
  description: string;
  category: string;
  created_at: string;
  user_id: string;
  likes: number;
  is_ai_generated: boolean;
  profiles?: { display_name: string | null };
}

const EXPLOIT_CATEGORIES = [
  { id: "digital", label: "Digital Evangelism", icon: Globe, description: "Social media, apps, websites" },
  { id: "local", label: "Local Outreach", icon: Users, description: "Community events, door-to-door" },
  { id: "isa58", label: "Isaiah 58 Ministry", icon: HandHeart, description: "Feeding, clothing, healing" },
  { id: "literature", label: "Literature Ministry", icon: BookOpen, description: "Tracts, books, studies" },
  { id: "creative", label: "Creative Arts", icon: Sparkles, description: "Music, drama, visual arts" },
  { id: "personal", label: "Personal Witness", icon: Heart, description: "One-on-one sharing" },
];

export function ExploitsHub({ churchId }: ExploitsHubProps) {
  const { user } = useAuth();
  const [ideas, setIdeas] = useState<ExploitIdea[]>([]);
  const [loading, setLoading] = useState(true);
  const [generating, setGenerating] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [generatedIdeas, setGeneratedIdeas] = useState<Array<{ title: string; description: string; category: string }>>([]);
  
  // Form state
  const [userIdea, setUserIdea] = useState("");
  const [selectedCategory, setSelectedCategory] = useState("local");
  const [refinePrompt, setRefinePrompt] = useState("");

  useEffect(() => {
    loadIdeas();
  }, [churchId]);

  const loadIdeas = async () => {
    try {
      const { data, error } = await supabase
        .from('church_community_posts')
        .select('*, profiles:user_id(display_name)')
        .eq('church_id', churchId)
        .eq('category', 'exploit')
        .order('created_at', { ascending: false });

      if (error) throw error;
      setIdeas(data?.map(d => {
        // Parse category info from title prefix [category] or default to 'local'
        const categoryMatch = d.title.match(/^\[([^\]]+)\]/);
        const extractedCategory = categoryMatch ? categoryMatch[1] : 'local';
        const cleanTitle = d.title.replace(/^\[[^\]]+\]\s*/, '');
        
        return {
          id: d.id,
          title: cleanTitle,
          description: d.content,
          category: extractedCategory,
          created_at: d.created_at || '',
          user_id: d.user_id,
          likes: d.likes || 0,
          is_ai_generated: d.content.includes('[AI-assisted]'),
          profiles: d.profiles
        };
      }) || []);
    } catch (error) {
      console.error('Error loading ideas:', error);
    } finally {
      setLoading(false);
    }
  };

  const generateIdeas = async (category?: string, prompt?: string) => {
    setGenerating(true);
    try {
      const { data, error } = await supabase.functions.invoke('generate-exploits', {
        body: { 
          category: category || selectedCategory,
          userPrompt: prompt || refinePrompt,
          churchId 
        }
      });

      if (error) throw error;
      
      setGeneratedIdeas(data.ideas || []);
      toast.success("Jeeves generated fresh missionary ideas!");
    } catch (error) {
      console.error('Error generating ideas:', error);
      toast.error("Failed to generate ideas. Try again.");
    } finally {
      setGenerating(false);
    }
  };

  const submitIdea = async () => {
    if (!userIdea.trim()) {
      toast.error("Please enter your idea");
      return;
    }

    setSubmitting(true);
    try {
      const { error } = await supabase
        .from('church_community_posts')
        .insert({
          church_id: churchId,
          user_id: user?.id,
          title: `[${selectedCategory}] ${userIdea.substring(0, 80)}`,
          content: userIdea,
          category: 'exploit'
        });

      if (error) throw error;

      toast.success("Your exploit idea has been shared!");
      setUserIdea("");
      loadIdeas();
    } catch (error) {
      console.error('Error submitting idea:', error);
      toast.error("Failed to submit idea");
    } finally {
      setSubmitting(false);
    }
  };

  const saveGeneratedIdea = async (idea: { title: string; description: string; category: string }) => {
    try {
      const { error } = await supabase
        .from('church_community_posts')
        .insert({
          church_id: churchId,
          user_id: user?.id,
          title: `[${idea.category}] ${idea.title}`,
          content: `${idea.description}\n\n[AI-assisted]`,
          category: 'exploit'
        });

      if (error) throw error;

      toast.success("Idea saved to community!");
      setGeneratedIdeas(prev => prev.filter(i => i.title !== idea.title));
      loadIdeas();
    } catch (error) {
      console.error('Error saving idea:', error);
      toast.error("Failed to save idea");
    }
  };

  const likeIdea = async (ideaId: string) => {
    try {
      const idea = ideas.find(i => i.id === ideaId);
      if (!idea) return;

      await supabase
        .from('church_community_posts')
        .update({ likes: (idea.likes || 0) + 1 })
        .eq('id', ideaId);

      setIdeas(prev => prev.map(i => 
        i.id === ideaId ? { ...i, likes: (i.likes || 0) + 1 } : i
      ));
    } catch (error) {
      console.error('Error liking idea:', error);
    }
  };

  const getCategoryIcon = (category: string) => {
    const cat = EXPLOIT_CATEGORIES.find(c => c.id === category);
    return cat?.icon || Lightbulb;
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <Card variant="glass" className="border-primary/20">
        <CardHeader>
          <div className="flex items-center gap-3">
            <div className="p-3 rounded-full bg-gradient-to-br from-amber-500 to-orange-600">
              <Flame className="h-6 w-6 text-white" />
            </div>
            <div>
              <CardTitle className="text-2xl flex items-center gap-2">
                Exploits for God
                <Badge variant="outline" className="ml-2 text-amber-500 border-amber-500/50">
                  Daniel 11:32
                </Badge>
              </CardTitle>
              <CardDescription className="text-base">
                "The people that do know their God shall be strong, and do exploits."
              </CardDescription>
            </div>
          </div>
        </CardHeader>
      </Card>

      <Tabs defaultValue="generate" className="space-y-4">
        <TabsList className="grid grid-cols-3 w-full max-w-md">
          <TabsTrigger value="generate" className="gap-2">
            <Sparkles className="h-4 w-4" />
            Generate Ideas
          </TabsTrigger>
          <TabsTrigger value="share" className="gap-2">
            <Share2 className="h-4 w-4" />
            Share Idea
          </TabsTrigger>
          <TabsTrigger value="community" className="gap-2">
            <Users className="h-4 w-4" />
            Community
          </TabsTrigger>
        </TabsList>

        {/* Generate Ideas Tab */}
        <TabsContent value="generate" className="space-y-4">
          <Card variant="glass">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Zap className="h-5 w-5 text-amber-500" />
                Jeeves Missionary Ideas Generator
              </CardTitle>
              <CardDescription>
                Let Jeeves help you brainstorm creative, biblical approaches to evangelism and mission.
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* Category Selection */}
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                {EXPLOIT_CATEGORIES.map((cat) => (
                  <Button
                    key={cat.id}
                    variant={selectedCategory === cat.id ? "default" : "outline"}
                    className={`h-auto py-3 flex flex-col items-center gap-1 ${
                      selectedCategory === cat.id ? "bg-primary" : ""
                    }`}
                    onClick={() => setSelectedCategory(cat.id)}
                  >
                    <cat.icon className="h-5 w-5" />
                    <span className="text-xs font-medium">{cat.label}</span>
                  </Button>
                ))}
              </div>

              {/* Optional Refinement */}
              <div className="space-y-2">
                <Label>Optional: Describe your context or specific needs</Label>
                <Textarea
                  placeholder="e.g., We're in a college town with many international students... or We want to reach busy professionals..."
                  value={refinePrompt}
                  onChange={(e) => setRefinePrompt(e.target.value)}
                  className="min-h-[80px]"
                />
              </div>

              <Button 
                onClick={() => generateIdeas()}
                disabled={generating}
                className="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700"
              >
                {generating ? (
                  <>
                    <Loader2 className="h-4 w-4 animate-spin mr-2" />
                    Jeeves is thinking...
                  </>
                ) : (
                  <>
                    <Sparkles className="h-4 w-4 mr-2" />
                    Generate Missionary Ideas
                  </>
                )}
              </Button>

              {/* Generated Ideas */}
              {generatedIdeas.length > 0 && (
                <div className="space-y-3 pt-4 border-t">
                  <h4 className="font-semibold flex items-center gap-2">
                    <Lightbulb className="h-4 w-4 text-amber-500" />
                    Jeeves Suggests:
                  </h4>
                  <div className="space-y-3">
                    {generatedIdeas.map((idea, idx) => (
                      <Card key={idx} className="bg-gradient-to-br from-amber-500/5 to-orange-500/5 border-amber-500/20">
                        <CardContent className="pt-4">
                          <div className="flex items-start justify-between gap-3">
                            <div className="flex-1">
                              <h5 className="font-semibold text-foreground">{idea.title}</h5>
                              <p className="text-sm text-muted-foreground mt-1">{idea.description}</p>
                              <Badge variant="outline" className="mt-2 text-xs">
                                {EXPLOIT_CATEGORIES.find(c => c.id === idea.category)?.label || idea.category}
                              </Badge>
                            </div>
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => saveGeneratedIdea(idea)}
                              className="shrink-0"
                            >
                              <Share2 className="h-4 w-4 mr-1" />
                              Save
                            </Button>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* Share Idea Tab */}
        <TabsContent value="share" className="space-y-4">
          <Card variant="glass">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Heart className="h-5 w-5 text-primary" />
                Share Your Exploit Idea
              </CardTitle>
              <CardDescription>
                Have a mission idea burning in your heart? Share it with the community!
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="space-y-2">
                <Label>Category</Label>
                <div className="flex flex-wrap gap-2">
                  {EXPLOIT_CATEGORIES.map((cat) => (
                    <Badge
                      key={cat.id}
                      variant={selectedCategory === cat.id ? "default" : "outline"}
                      className="cursor-pointer"
                      onClick={() => setSelectedCategory(cat.id)}
                    >
                      {cat.label}
                    </Badge>
                  ))}
                </div>
              </div>

              <div className="space-y-2">
                <Label>Your Idea</Label>
                <Textarea
                  placeholder="Describe your missionary or evangelism idea... What's the vision? How would it work? What's the biblical foundation?"
                  value={userIdea}
                  onChange={(e) => setUserIdea(e.target.value)}
                  className="min-h-[150px]"
                />
              </div>

              <div className="flex gap-2">
                <Button
                  variant="outline"
                  onClick={() => generateIdeas(selectedCategory, userIdea)}
                  disabled={generating || !userIdea.trim()}
                  className="flex-1"
                >
                  {generating ? (
                    <Loader2 className="h-4 w-4 animate-spin mr-2" />
                  ) : (
                    <RefreshCw className="h-4 w-4 mr-2" />
                  )}
                  Refine with Jeeves
                </Button>
                <Button 
                  onClick={submitIdea}
                  disabled={submitting || !userIdea.trim()}
                  className="flex-1"
                >
                  {submitting ? (
                    <Loader2 className="h-4 w-4 animate-spin mr-2" />
                  ) : (
                    <Send className="h-4 w-4 mr-2" />
                  )}
                  Share with Community
                </Button>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Community Tab */}
        <TabsContent value="community" className="space-y-4">
          <Card variant="glass">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Users className="h-5 w-5 text-primary" />
                Community Exploit Ideas
              </CardTitle>
              <CardDescription>
                Ideas shared by your church family for doing great things for God.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {loading ? (
                <div className="flex items-center justify-center py-12">
                  <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                </div>
              ) : ideas.length === 0 ? (
                <div className="text-center py-12">
                  <Compass className="h-12 w-12 text-muted-foreground/40 mx-auto mb-4" />
                  <p className="text-muted-foreground">No ideas shared yet</p>
                  <p className="text-sm text-muted-foreground/70">Be the first to share a missionary idea!</p>
                </div>
              ) : (
                <ScrollArea className="h-[500px]">
                  <div className="space-y-4 pr-4">
                    {ideas.map((idea) => {
                      const Icon = getCategoryIcon(idea.category);
                      return (
                        <Card key={idea.id} className="bg-card/50 hover:bg-card/80 transition-colors">
                          <CardContent className="pt-4">
                            <div className="flex items-start gap-3">
                              <div className="p-2 rounded-lg bg-primary/10">
                                <Icon className="h-5 w-5 text-primary" />
                              </div>
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 flex-wrap">
                                  <h4 className="font-semibold">{idea.title}</h4>
                                  {idea.is_ai_generated && (
                                    <Badge variant="secondary" className="text-xs">
                                      <Sparkles className="h-3 w-3 mr-1" />
                                      AI-assisted
                                    </Badge>
                                  )}
                                </div>
                                <p className="text-sm text-muted-foreground mt-1 line-clamp-3">
                                  {idea.description}
                                </p>
                                <div className="flex items-center gap-4 mt-3">
                                  <Button
                                    variant="ghost"
                                    size="sm"
                                    onClick={() => likeIdea(idea.id)}
                                    className="text-muted-foreground hover:text-primary"
                                  >
                                    <ThumbsUp className="h-4 w-4 mr-1" />
                                    {idea.likes || 0}
                                  </Button>
                                  <span className="text-xs text-muted-foreground">
                                    by {idea.profiles?.display_name || 'Anonymous'}
                                  </span>
                                  <Badge variant="outline" className="text-xs">
                                    {EXPLOIT_CATEGORIES.find(c => c.id === idea.category)?.label || idea.category}
                                  </Badge>
                                </div>
                              </div>
                            </div>
                          </CardContent>
                        </Card>
                      );
                    })}
                  </div>
                </ScrollArea>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}
