import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { category, userPrompt, churchId } = await req.json();
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");

    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    const categoryDescriptions: Record<string, string> = {
      digital: "digital evangelism: social media campaigns, apps, websites, podcasts, YouTube ministry, online Bible studies",
      local: "local community outreach: community events, food banks, homeless ministry, neighborhood door-to-door",
      isa58: "Isaiah 58-based ministry: feeding the hungry, clothing the naked, visiting the sick and imprisoned, practical compassion",
      literature: "literature evangelism: tract distribution, book sharing, Bible study guides, GLOW tracts",
      creative: "creative arts ministry: music, drama, art exhibitions, poetry, dance for worship and witness",
      personal: "personal witnessing: one-on-one Bible studies, friendship evangelism, workplace witness, testimony sharing"
    };

    const categoryContext = categoryDescriptions[category] || categoryDescriptions.local;

    const systemPrompt = `You are Jeeves, a spiritually mature AI assistant for a Seventh-day Adventist church. You help generate creative, biblically-grounded missionary and evangelism ideas.

Your responses should:
- Be rooted in Scripture and the Great Commission (Matthew 28:19-20)
- Reflect the spirit of Daniel 11:32 - "the people that know their God shall be strong and do exploits"
- Include practical, actionable steps
- Consider both urban and rural contexts
- Honor the three angels' messages and present truth
- Be culturally sensitive and inclusive
- Emphasize relationship-building over programs
- Include Isaiah 58 principles of practical godliness when relevant

Generate 3-4 unique, creative missionary ideas that can be implemented by local church members.`;

    const userMessage = userPrompt 
      ? `Generate missionary ideas for ${categoryContext}. The user has this specific context or need: "${userPrompt}". Provide 3-4 creative, practical ideas.`
      : `Generate 3-4 creative missionary ideas focused on ${categoryContext}. Make them practical for a local church to implement.`;

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-flash",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userMessage }
        ],
        tools: [
          {
            type: "function",
            function: {
              name: "generate_exploit_ideas",
              description: "Generate missionary and evangelism ideas",
              parameters: {
                type: "object",
                properties: {
                  ideas: {
                    type: "array",
                    items: {
                      type: "object",
                      properties: {
                        title: { type: "string", description: "A catchy, memorable title for the idea" },
                        description: { type: "string", description: "A 2-3 sentence description of the idea, including practical steps and biblical foundation" },
                        category: { type: "string", enum: ["digital", "local", "isa58", "literature", "creative", "personal"] }
                      },
                      required: ["title", "description", "category"]
                    }
                  }
                },
                required: ["ideas"]
              }
            }
          }
        ],
        tool_choice: { type: "function", function: { name: "generate_exploit_ideas" } }
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error("AI API error:", response.status, errorText);
      throw new Error(`AI API error: ${response.status}`);
    }

    const data = await response.json();
    
    // Extract ideas from tool call
    const toolCall = data.choices?.[0]?.message?.tool_calls?.[0];
    let ideas = [];
    
    if (toolCall?.function?.arguments) {
      const parsed = JSON.parse(toolCall.function.arguments);
      ideas = parsed.ideas || [];
    }

    return new Response(
      JSON.stringify({ ideas }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (error) {
    console.error("Error generating exploits:", error);
    return new Response(
      JSON.stringify({ 
        error: error instanceof Error ? error.message : "Unknown error",
        ideas: [
          {
            title: "Community Garden Ministry",
            description: "Start a community garden that provides fresh produce for neighbors while creating opportunities for spiritual conversations. Based on Isaiah 58:10 - sharing your food with the hungry.",
            category: "isa58"
          },
          {
            title: "Digital Bible Study Series",
            description: "Create a weekly YouTube or podcast series addressing life questions from a biblical perspective. Share on social media and invite friends to watch together.",
            category: "digital"
          },
          {
            title: "Friendship Evangelism Cards",
            description: "Design beautiful cards with encouraging Bible verses and your church's contact info. Give to service workers, neighbors, and new acquaintances as a natural way to share hope.",
            category: "personal"
          }
        ]
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
